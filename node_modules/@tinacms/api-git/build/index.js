!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("fs"),require("path"),require("express"),require("multer")):"function"==typeof define&&define.amd?define(["exports","fs","path","express","multer"],t):t((e=e||self)["@tinacms/api-git"]={},e.fs$1,e.path$1,e.express$1,e.multer)}(this,function(e,h,p,s,t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var n=function(){return(n=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function m(a,o,u,i){return new(u=u||Promise)(function(e,t){function n(e){try{r(i.next(e))}catch(e){t(e)}}function s(e){try{r(i.throw(e))}catch(e){t(e)}}function r(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(n,s)}r((i=i.apply(a,o||[])).next())})}function d(n,s){var r,a,o,e,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,a&&(o=2&t[0]?a.return:t[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,t[1])).done)return o;switch(a=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,a=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=s.call(n,u)}catch(e){t=[6,e],a=0}finally{r=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var r=require("fs"),a=require("path"),o=!1,u=null,i=1e3;function v(e,t){!function(e,t){u=[e,t]}(e,t),c()}function c(){if(u&&!o){var e=u[0],t=u[1];o=!0,u=null;var n=a.dirname(e);r.existsSync(n)||r.mkdirSync(n,{recursive:!0}),r.writeFile(e,t,function(e){e?(console.error(e),o=!1):(o=!0,setTimeout(l,i))})}}function l(){o=!1,c()}var f=require("simple-git/promise"),b="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no";function y(e){var t=f(e);return t.env(n({},process.env,{GIT_SSH_COMMAND:b})),t}function g(e){var o=e.files,u=e.message,i=e.name,c=e.email,l=e.pathRoot,f=e.push;return m(this,void 0,void 0,function(){var t,n,s,r,a;return d(this,function(e){switch(e.label){case 0:return c&&(t={"--author":'"'+(i||c)+" <"+c+'>"'}),[4,(n=y(l)).revparse(["--abbrev-ref","HEAD"])];case 1:return s=e.sent(),[4,n.add(o)];case 2:return e.sent(),[4,n.commit(u,o,t)];case 3:return r=e.sent(),f?[4,n.push(["-u","origin",s])]:[3,5];case 4:return a=e.sent(),[3,6];case 5:a=r,e.label=6;case 6:return[2,a]}})})}function j(s){var e=t.diskStorage({destination:function(e,t,n){!function(t,n){h.exists(t,function(e){e?n():h.mkdir(t,function(){n()})})}(s,function(){n(null,s)})},filename:function(e,t,n){n(null,t.originalname)}});return t({storage:e})}function w(e,t){var n=p.resolve(e),s=p.resolve(t);return!!n.startsWith(s)}function P(o){var t=this;void 0===o&&(o={});var u=o.pathToRepo||process.cwd(),i=o.pathToContent||"",c=p.join(u,i),a=p.join(c,"/tmp/"),l=o.defaultCommitMessage||"Update from Tina",f="boolean"!=typeof o.pushOnCommit||o.pushOnCommit,e=j(a),n=s.Router();return n.use(s.json()),n.delete("/:relPath",function(e,t){var n=decodeURIComponent(e.params.relPath),s=p.join(c,n);try{!function(e){r.unlinkSync(e)}(s)}catch(e){t.status(500).json({status:"error",message:e.message})}g({pathRoot:u,name:e.body.name||o.defaultCommitName,email:e.body.email||o.defaultCommitEmail,message:"Update from Tina: delete "+n,push:f,files:[s]}).then(function(){t.json({status:"success"})}).catch(function(e){t.status(500).json({status:"error",message:e.message})})}),n.put("/:relPath",function(e,t){var n=decodeURIComponent(e.params.relPath),s=p.join(c,n);try{if(!w(s,c))throw new Error("Failed to write to: "+n+" \nCannot write outside of the content directory.");v(s,e.body.content),t.json({content:e.body.content})}catch(e){t.status(500).json({status:"error",message:e.message})}}),n.post("/upload",e.single("file"),function(e,t){try{var n=e.file.originalname,s=p.join(a,n),r=p.join(u,e.body.directory,n);h.rename(s,r,function(e){e&&console.error(e)}),t.send(e.file)}catch(e){t.status(500).json({status:"error",message:e.message})}}),n.post("/commit",function(r,a){return m(t,void 0,void 0,function(){var t,n,s;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=r.body.message||l,n=r.body.files.map(function(e){return p.join(c,e)}),[4,g({pathRoot:u,name:r.body.name||o.defaultCommitName,email:r.body.email||o.defaultCommitEmail,push:f,message:t,files:n})];case 1:return e.sent(),a.json({status:"success"}),[3,3];case 2:return s=e.sent(),a.status(412),a.json({status:"failure",error:s.message}),[3,3];case 3:return[2]}})})}),n.post("/push",function(e,n){return m(t,void 0,void 0,function(){var t;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y(u).push()];case 1:return e.sent(),n.json({status:"success"}),[3,3];case 2:return t=e.sent(),n.status(412),n.json({status:"failure",error:t.message}),[3,3];case 3:return[2]}})})}),n.post("/reset",function(e,t){var n=y(u),s=e.body.files.map(function(e){return p.join(c,e)});n.checkout(s[0]).then(function(){t.json({status:"success"})}).catch(function(e){t.status(412),t.json({status:"failure",error:e.message})})}),n.get("/branch",function(e,s){return m(t,void 0,void 0,function(){var t,n;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y(u).branchLocal()];case 1:return t=e.sent(),s.send({status:"success",branch:t.branches[t.current]}),[3,3];case 2:return n=e.sent(),s.status(500),s.json({status:"failure",message:n.message}),[3,3];case 3:return[2]}})})}),n.get("/branches",function(e,s){return m(t,void 0,void 0,function(){var t,n;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y(u).branchLocal()];case 1:return t=e.sent(),s.send({status:"success",branches:t.all}),[3,3];case 2:return n=e.sent(),s.status(500),s.json({status:"failure",message:n.message}),[3,3];case 3:return[2]}})})}),n.get("/branches/:name",function(r,a){return m(t,void 0,void 0,function(){var t,n,s;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,y(u).branchLocal()];case 1:return t=e.sent(),(n=t.branches[r.params.name])?(a.send({status:"success",branch:n}),[3,3]):(a.status(404),a.json({status:"failure",message:"Branch not found: "+String(n)}),[2]);case 2:return s=e.sent(),a.status(500),a.json({status:"failure",message:s.message}),[3,3];case 3:return[2]}})})}),n.get("/show/:fileRelativePath",function(r,a){return m(t,void 0,void 0,function(){var t,n,s;return d(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=p.join(i,r.params.fileRelativePath).replace(/^\/*/,""),[4,function(e){var n=e.pathRoot,s=e.fileRelativePath;return m(this,void 0,void 0,function(){var t;return d(this,function(e){switch(e.label){case 0:t=y(n),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.show(["HEAD:"+s])];case 2:return[2,e.sent()];case 3:return e.sent(),[2,h.readFileSync(p.join(n,s),"utf8")];case 4:return[2]}})})}({pathRoot:u,fileRelativePath:t})];case 1:return n=e.sent(),a.json({fileRelativePath:r.params.fileRelativePath,content:n,status:"success"}),[3,3];case 2:return s=e.sent(),a.status(501),a.json({status:"failure",message:s.message,fileRelativePath:r.params.fileRelativePath}),[3,3];case 3:return[2]}})})}),n}var R=require("express"),x=require("cors"),C=(S.prototype.start=function(e){this.server.listen(e),console.log("TinaCMS git API server running on localhost:"+e)},S);function S(e){this.server=R(),this.server.use(x()),this.server.use("/___tina",P(e))}e.GitApiServer=C,e.checkFilePathIsInRepo=w,e.router=P,Object.defineProperty(e,"__esModule",{value:!0})});
