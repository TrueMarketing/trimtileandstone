!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("path"),require("fs"),require("express"),require("multer"),require("simple-git/promise"),require("os"),require("cors"),require("atob")):"function"==typeof define&&define.amd?define(["exports","path","fs","express","multer","simple-git/promise","os","cors","atob"],t):t((e=e||self)["@tinacms/api-git"]={},e.path,e.fs,e.express,e.multer,e.git,e.os,e.cors,e.atob)}(this,function(e,d,m,s,a,n,i,u,o){"use strict";var c="default"in d?d.default:d,l="default"in m?m.default:m,h="default"in s?s.default:s;a=a&&a.hasOwnProperty("default")?a.default:a,n=n&&n.hasOwnProperty("default")?n.default:n,u=u&&u.hasOwnProperty("default")?u.default:u,o=o&&o.hasOwnProperty("default")?o.default:o;var v=function(){return(v=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function g(o,s,a,u){return new(a=a||Promise)(function(e,t){function n(e){try{i(u.next(e))}catch(e){t(e)}}function r(e){try{i(u.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,r)}i((u=u.apply(o,s||[])).next())})}function y(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var f=!1;function t(){this.pendingChanges=[]}var p=new(Object.defineProperty(t.prototype,"length",{get:function(){return this.pendingChanges.length},enumerable:!0,configurable:!0}),t.prototype.addFileChange=function(n){var e=this.pendingChanges.findIndex(function(e){var t=e.filepath;return n.filepath===t});e<0?this.pendingChanges.push(n):this.pendingChanges[e]=n},t.prototype.getNextFileChange=function(){return this.pendingChanges.shift()},t),b=1e3;function r(e,t){!function(e,t){p.addFileChange({filepath:e,content:t})}(e,t),w()}function w(){if(p.length&&!f){var e=p.getNextFileChange()||{filepath:"",content:""},t=e.filepath,n=e.content;f=!0;var r=c.dirname(t);l.existsSync(r)||l.mkdirSync(r,{recursive:!0}),l.writeFile(t,n,function(e){e?(console.error(e),f=!1):(f=!0,setTimeout(P,b))})}}function P(){f=!1,w()}var C=function(e){if(R(e))return e;var t=e.match(new RegExp("https://(.*?@)?(.+?)/(.*?)(?:.git)?$"));return"git@"+(t&&2<t.length?t[2]:"")+":"+(t&&3<t.length?t[3]:"")+".git"},R=function(e){return e.startsWith("git@")||e.startsWith("ssh://")};var j=(Object.defineProperty(T.prototype,"contentAbsolutePath",{get:function(){return d.join(this.pathToRepo,this.pathToContent)},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"tmpDir",{get:function(){return d.join(this.contentAbsolutePath,"/tmp")},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"sshKeyPath",{get:function(){return d.join(this.pathToRepo,this.SSH_KEY_RELATIVE_PATH)},enumerable:!0,configurable:!0}),T.prototype.fileAbsolutePath=function(e){return d.join(this.contentAbsolutePath,e)},T.prototype.fileRelativePath=function(e){return d.posix.join(this.pathToContent,e)},T.prototype.fileIsInRepo=function(e){return function(e,t){var n,r=d.resolve(e);return n="Windows_NT"===i.type()?d.resolve(t).replace(/\\+$/,"")+"\\":d.resolve(t).replace(/\/+$/,"")+"/",r.startsWith(n)}(e,this.contentAbsolutePath)},T.prototype.writeFile=function(e,t){var n=this.fileAbsolutePath(e);if(!this.fileIsInRepo(n))throw new Error("Failed to write to: "+e+" \nCannot write outside of the content directory.");r(n,t)},T.prototype.deleteFiles=function(n,r){return g(this,void 0,void 0,function(){var t;return y(this,function(e){switch(e.label){case 0:return t=this.fileAbsolutePath(n),this.fileIsInRepo(t)?(function(e){l.unlinkSync(e)}(t),[4,this.commit(r)]):[3,2];case 1:return e.sent(),[3,3];case 2:throw new Error("Failed to delete: "+n+" \nCannot delete outside of the content directory.");case 3:return[2]}})})},T.prototype.commit=function(c){return g(this,void 0,void 0,function(){var t,n,r,i,o,s,a,u=this;return y(this,function(e){switch(e.label){case 0:return t=c.files,n=c.message,r=c.name,i=c.email,o=t.map(function(e){return u.fileAbsolutePath(e)}),c.email&&(s={"--author":'"'+(r||i)+" <"+i+'>"'}),[4,(a=this.open()).add(o)];case 1:return e.sent(),[4,a.commit(n,o,s)];case 2:return[2,e.sent()]}})})},T.prototype.push=function(){return g(this,void 0,void 0,function(){var t,n;return y(this,function(e){switch(e.label){case 0:return[4,(t=this.open()).revparse(["--abbrev-ref","HEAD"])];case 1:return n=e.sent(),[2,t.push(["-u","origin",n])]}})})},T.prototype.reset=function(e){var t=this.fileAbsolutePath(e);return this.open().checkout(t)},T.prototype.getFileAtHead=function(n){return g(this,void 0,void 0,function(){var t;return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),t=this.fileRelativePath(n),[4,this.open().show(["HEAD:"+t.replace(/^\/*/,"")])];case 1:return[2,e.sent()];case 2:return e.sent(),[2,m.readFileSync(this.fileAbsolutePath(n),{encoding:"utf8"})];case 3:return[2]}})})},T.prototype.getOrigin=function(){return g(this,void 0,void 0,function(){var t,n;return y(this,function(e){switch(e.label){case 0:return[4,this.open().getRemotes(!0)];case 1:return t=e.sent(),(n=t.filter(function(e){return"origin"==e.name})).length?[2,n[0].refs.push]:(console.warn("No origin remote on the given repo"),[2])}})})},T.prototype.updateOrigin=function(n){return g(this,void 0,void 0,function(){var t;return y(this,function(e){switch(e.label){case 0:return[4,(t=this.open()).getRemotes(!0)];case 1:return e.sent().filter(function(e){return"origin"==e.name}).length&&console.warn("Changing remote origin to "+n),[4,t.removeRemote("origin")];case 2:return e.sent(),[4,t.addRemote("origin",n)];case 3:return e.sent(),[2]}})})},T.prototype.open=function(){var e=n(this.pathToRepo),t=["-o UserKnownHostsFile=/dev/null","-o StrictHostKeyChecking=no"];try{m.statSync(this.sshKeyPath),t=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}(t,["-o IdentitiesOnly=yes","-i "+this.sshKeyPath,"-F /dev/null"])}catch(e){console.warn("No SSH key set.")}return e.env(v(v({GIT_COMMITTER_EMAIL:"tina@tinacms.org",GIT_COMMITTER_NAME:"TinaCMS"},process.env),{GIT_SSH_COMMAND:"ssh "+t.join(" ")})),e},T);function T(e,t){void 0===e&&(e=process.cwd()),void 0===t&&(t=""),this.pathToRepo=e,this.pathToContent=t,this.SSH_KEY_RELATIVE_PATH=".ssh/id_rsa"}var O="Git Operation failed: Check the logs for more details",S={defaultCommitMessage:"Edited with TinaCMS",defaultCommitName:"TinaCMS",defaultCommitEmail:"git@tinacms.org",pushOnCommit:!0};function A(c,e){var o=this;void 0===e&&(e={});var t=v(v({},S),e),l=t.defaultCommitMessage,h=t.defaultCommitName,f=t.defaultCommitEmail,p=t.pushOnCommit;if(!c)throw new Error("@tinacms/api-git#router(repo, config): Parameter `repo` is missing.");if(!(c instanceof j)){var n=c;c=new j(n.pathToRepo,n.pathToContent)}var r=function(r){var e=a.diskStorage({destination:function(e,t,n){m.mkdir(r,{recursive:!0},function(){n(null,r)})},filename:function(e,t,n){n(null,t.originalname)}});return a({storage:e})}(c.tmpDir),i=s.Router();return i.use(s.json()),i.delete("/:relPath",function(r,i){return g(o,void 0,void 0,function(){var t,n;return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),t=r.user||{},n=decodeURIComponent(r.params.relPath),[4,c.deleteFiles(n,{name:t.name||r.body.name||h,email:t.email||r.body.email||f,message:"Update from Tina: delete "+n,files:[n]})];case 1:return e.sent(),p?[4,c.push()]:[3,3];case 2:e.sent(),e.label=3;case 3:return i.json({status:"success"}),[3,5];case 4:return e.sent(),i.status(500).json({status:"error",message:O}),[3,5];case 5:return[2]}})})}),i.put("/:relPath",function(e,t){try{var n=decodeURIComponent(e.params.relPath);c.writeFile(n,e.body.content),t.json({content:e.body.content})}catch(e){t.status(500).json({status:"error",message:O})}}),i.post("/upload",r.single("file"),function(a,u){return g(o,void 0,void 0,function(){var t,n,r,i,o,s;return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),t=a.user||{},n=a.body.message||l,r=a.file.originalname,i=d.join(c.tmpDir,r),o=d.join(a.body.directory,r),s=c.fileAbsolutePath(o),c.fileIsInRepo(s)?(m.renameSync(i,s),[4,c.commit({name:t.name||a.body.name||h,email:t.email||a.body.email||f,message:n,files:[o]})]):[3,4];case 1:return e.sent(),p?[4,c.push()]:[3,3];case 2:e.sent(),e.label=3;case 3:u.send(a.file),e.label=4;case 4:return[3,6];case 5:return e.sent(),u.status(500).json({status:"error",message:O}),[3,6];case 6:return[2]}})})}),i.post("/commit",function(r,i){return g(o,void 0,void 0,function(){var t,n;return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),t=r.user||{},n=r.body.message||l,[4,c.commit({name:t.name||r.body.name||h,email:t.email||r.body.email||f,message:n,files:r.body.files})];case 1:return e.sent(),p?[4,c.push()]:[3,3];case 2:e.sent(),e.label=3;case 3:return i.json({status:"success"}),[3,5];case 4:return e.sent(),i.status(412).json({status:"failure",error:O}),[3,5];case 5:return[2]}})})}),i.post("/push",function(e,t){return g(o,void 0,void 0,function(){return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,c.push()];case 1:return e.sent(),t.json({status:"success"}),[3,3];case 2:return e.sent(),t.status(412).json({status:"failure",error:O}),[3,3];case 3:return[2]}})})}),i.post("/reset",function(t,n){return g(o,void 0,void 0,function(){return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,c.reset(t.body.files[0])];case 1:return e.sent(),n.json({status:"success"}),[3,3];case 2:return e.sent(),n.status(412).json({status:"failure",error:O}),[3,3];case 3:return[2]}})})}),i.get("/show/:fileRelativePath",function(n,r){return g(o,void 0,void 0,function(){var t;return y(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,c.getFileAtHead(n.params.fileRelativePath)];case 1:return t=e.sent(),r.json({fileRelativePath:n.params.fileRelativePath,content:t,status:"success"}),[3,3];case 2:return e.sent(),r.status(501),r.json({status:"failure",message:O,fileRelativePath:n.params.fileRelativePath}),[3,3];case 3:return[2]}})})}),i}function E(r){return g(this,void 0,void 0,function(){var t,n;return y(this,function(e){switch(e.label){case 0:return[4,r.getOrigin()];case 1:return!(t=e.sent())||R(t)?[3,3]:(n=C(t),[4,r.updateOrigin(n)]);case 2:e.sent(),e.label=3;case 3:return[2]}})})}function I(t,n,r){return g(this,void 0,void 0,function(){return y(this,function(e){switch(e.label){case 0:return r&&function(e,t){var n=d.dirname(e.sshKeyPath);m.mkdirSync(n,{recursive:!0}),m.writeFileSync(e.sshKeyPath,o(t),{encoding:"utf8",mode:384})}(t,r),n?[4,t.updateOrigin(n)]:[3,2];case 1:return e.sent(),[3,4];case 2:return[4,E(t)];case 3:e.sent(),e.label=4;case 4:return[2]}})})}var _=(x.prototype.start=function(e){this.server.listen(e),console.log("TinaCMS git API server running on localhost:"+e)},x);function x(e){var t=e.pathToRepo,n=e.pathToContent,r=e.gitRemote,i=e.sshKey,o=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(e,["pathToRepo","pathToContent","gitRemote","sshKey"]),s=new j(t,n);void 0!==process.env.TINA_CEE&&I(s,r,i),this.server=h(),this.server.use(u()),this.server.use("/___tina",A(s,o))}e.GitApiServer=_,e.Repo=j,e.configureGitRemote=I,e.router=A,e.updateRemoteToSSH=E,Object.defineProperty(e,"__esModule",{value:!0})});
